<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="format-detection" content="telephone=no" />
	<title>Map</title>
	<!-- Libraries -->
	<script src="http://knockoutjs.com/downloads/knockout-2.3.0.js"></script>
	<style>
		.remove{
			display: none;
		}
		.added{
			background: #efefef;
			color: #777777;
		}
		.added .remove{
			display: block;
		}
	</style>
</head>
<body>
<button data-bind="click: getJSON.bind($data, false)" style="position: fixed; top: 0; left: 0;">Show in console</button>
<button data-bind="click: getJSON.bind($data, true)" style="position: fixed; top: 0; left: 130px;">Show in alert</button>
<table border="1">
	<colgroup>
		<col width="200" />
		<col width="150" />
		<col width="50" />
		<col width="60" />
	</colgroup>
	<thead>
	<tr>
		<th>NAME</th>
		<th>Image</th>
		<th>Visits</th>
		<th></th>
	</tr>
	</thead>
	<tbody data-bind="foreach: slides">
	<tr data-bind="css: {added: added}">
		<td data-bind="text: name"></td>
		<td><img data-bind="attr: {src: url}" /></td>
		<td><input type="text" data-bind="value: visits" maxlength="8" /></td>
		<td>
			<button data-bind="click: $parent.addToVisit">add</button>
			<button class="remove" data-bind="click: $parent.removeFromVisit">remove</button>
		</td>
	</tr>
	</tbody>
</table>
<script>
	var defaultVisitNumber = window.location.search.replace("?", '') || "1", defaultURL = "", hash = window.location.hash.replace("#", '');
	if(hash !== ''){
		defaultURL = "../" + hash + "/";
	}
	function loadJson(json, callBack){
		var chapters, allSlides = [], xhr = new XMLHttpRequest();
		xhr.onreadystatechange = function(){
			if(this.readyState === 4){
				structure = JSON.parse(this.responseText);
				chapters = structure.chapters;

				chapters.forEach(function(chapter){
					var slides = chapter.slides, i = 0;
					for(i = 0; i < slides.length; i++){
						allSlides.push({
							"name": slides[i],
							"added": ko.observable(false),
							"url": defaultURL + "content/images/thumbs/" + slides[i] + ".png",
							"visits": defaultVisitNumber
						});
					}
				});
				callBack(allSlides);
			}
		};
		xhr.open('GET', json, true);
		xhr.send(null);
	}
	loadJson(defaultURL + 'content/structure.json', function(slides){
		viewModel = {};
		viewModel.slides = slides;
		viewModel.slidesJSON = ko.observableArray([]);
		viewModel.addToVisit = function(item){
			var arr = [], temp = item.visits, length , i;
			if(temp.indexOf(",") > -1){
				temp = temp.split(",");
				length = temp.length;
				for(i = 0; i < length; i++){
					arr[i] = parseInt(temp[i]);
				}
			}else{
				arr = [parseInt(temp)];
			}
			viewModel.slidesJSON.push({
				"id": item.name,
				"visits": arr
			});
			item.added(true);
		};
		viewModel.removeFromVisit = function(addedItem){
			addedItem.added(false);
			viewModel.slidesJSON(viewModel.slidesJSON.remove(function(item){
				return item.name === addedItem.name;
			}));
		};
		viewModel.getJSON = function(showInAlert){
			var jsonString = JSON.stringify(viewModel.slidesJSON()), result = jsonString.slice(1, jsonString.length - 1);
			if(!showInAlert){
				console.log(result);
			}else{
				alert(result);
			}
		};

		ko.applyBindings(viewModel);
	});
</script>
</body>
</html>